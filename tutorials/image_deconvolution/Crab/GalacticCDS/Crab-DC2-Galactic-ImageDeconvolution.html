<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DC2 Image Analysis, Crab, Image Deconvolution using CDS in the Galactic coordinate system &mdash; cosipy __version__ = &#34;0.2.1&#34;
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=0aed9c3d"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            cosipy
              <img src="../../../../_static/cosipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../other_examples.html">Other examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">cosipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">DC2 Image Analysis, Crab, Image Deconvolution using CDS in the Galactic coordinate system</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/tutorials/image_deconvolution/Crab/GalacticCDS/Crab-DC2-Galactic-ImageDeconvolution.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="DC2-Image-Analysis,-Crab,-Image-Deconvolution-using-CDS-in-the-Galactic-coordinate-system">
<h1>DC2 Image Analysis, Crab, Image Deconvolution using CDS in the Galactic coordinate system<a class="headerlink" href="#DC2-Image-Analysis,-Crab,-Image-Deconvolution-using-CDS-in-the-Galactic-coordinate-system" title="Link to this heading"></a></h1>
<p>updated on 2024-02-22 (the commit f27cd0bee26c56a93d34a06f2c0af88cb1f59f6e)</p>
<p>This notebook focuses on the image deconvolution with the Compton data space (CDS) in the Galactic coordinate system. An example of the image analysis will be presented using the the Crab 3-month simulation data created for DC2.</p>
<p>In DC2, we have two options on the coordinate system to describe the Compton scattering direction (<span class="math notranslate nohighlight">\(\chi\psi\)</span>) in the image deconvolution. Please also check the notes written in Crab-DC2-ScAtt-DataReduction.ipynb.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from histpy import Histogram, HealpixAxis, Axis, Axes
from mhealpy import HealpixMap
from astropy.coordinates import SkyCoord, cartesian_to_spherical, Galactic

from cosipy.response import FullDetectorResponse
from cosipy.spacecraftfile import SpacecraftFile
from cosipy.ts_map.TSMap import TSMap
from cosipy.data_io import UnBinnedData, BinnedData
from cosipy.image_deconvolution import SpacecraftAttitudeExposureTable, CoordsysConversionMatrix, DataLoader, ImageDeconvolution
from cosipy.util import fetch_wasabi_file

# cosipy uses astropy units
import astropy.units as u
from astropy.units import Quantity
from astropy.coordinates import SkyCoord
from astropy.time import Time
from astropy.table import Table
from astropy.io import fits
from scoords import Attitude, SpacecraftFrame

#3ML is needed for spectral modeling
from threeML import *
from astromodels import Band

#Other standard libraries
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.gridspec import GridSpec
import os

import healpy as hp
from tqdm.autonotebook import tqdm

%matplotlib inline
</pre></div>
</div>
</div>
</section>
<section id="0.-Files-needed-for-this-notebook">
<h1>0. Files needed for this notebook<a class="headerlink" href="#0.-Files-needed-for-this-notebook" title="Link to this heading"></a></h1>
<p>From wasabi - cosi-pipeline-public/COSI-SMEX/DC2/Responses/PointSourceReponse/psr_gal_continuum_DC2.h5.zip (please unzip it) - a pre-computed continuum response file converted into the Galactic coordinate system - cosi-pipeline-public/COSI-SMEX/DC2/Data/Sources/Crab_DC2_3months_unbinned_data.fits.gz - cosi-pipeline-public/COSI-SMEX/DC2/Data/Backgrounds/albedo_photons_3months_unbinned_data.fits.gz - In this notebook, only the albedo gamma-ray background is considered for a tutorial. - If you want
to consider all of the background components, please replace it with cosi-pipeline-public/COSI-SMEX/DC2/Data/Backgrounds/total_bg_3months_unbinned_data.fits.gz - Note that total_bg_3months_unbinned_data.fits.gz is 14.15 GB.</p>
<p>From docs/tutorials/image_deconvolution/Crab/GalacticCDS - inputs_Crab_DC2.yaml - imagedeconvolution_parfile_gal_Crab.yml - crab_spec.dat</p>
<p>You can download the data and detector response from wasabi. You can skip this cell if you already have downloaded the files.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Response file:
# wasabi path: COSI-SMEX/DC2/Responses/PointSourceReponse/psr_gal_continuum_DC2.h5.zip
# File size: 6.7G
fetch_wasabi_file(&#39;COSI-SMEX/DC2/Responses/PointSourceReponse/psr_gal_continuum_DC2.h5.zip&#39;)
os.system(&quot;unzip psr_gal_continuum_DC2.h5.zip&quot;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Source file (Crab):
# wasabi path: COSI-SMEX/DC2/Data/Sources/Crab_DC2_3months_unbinned_data.fits.gz
# File size: 619.22 MB
fetch_wasabi_file(&#39;COSI-SMEX/DC2/Data/Sources/Crab_DC2_3months_unbinned_data.fits.gz&#39;)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span># Background file (albedo gamma):
# wasabi path: COSI-SMEX/DC2/Data/Backgrounds/albedo_photons_3months_unbinned_data.fits.gz
# File size: 2.69 GB
fetch_wasabi_file(&#39;COSI-SMEX/DC2/Data/Backgrounds/albedo_photons_3months_unbinned_data.fits.gz&#39;)
</pre></div>
</div>
</div>
</section>
<section id="1.-Create-binned-event/background-files-in-the-Galactic-coordinate-system">
<h1>1. Create binned event/background files in the Galactic coordinate system<a class="headerlink" href="#1.-Create-binned-event/background-files-in-the-Galactic-coordinate-system" title="Link to this heading"></a></h1>
<p>please modify “path_data” corresponding to your environment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>path_data = &quot;path/to/data/&quot;
</pre></div>
</div>
</div>
<p><strong>Source</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

signal_filepath = path_data + &quot;Crab_DC2_3months_unbinned_data.fits.gz&quot;

binned_signal = BinnedData(input_yaml = &quot;inputs_Crab_DC2.yaml&quot;)

binned_signal.get_binned_data(unbinned_data = signal_filepath, psichi_binning=&quot;galactic&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
binning data...
Time unit: s
Em unit: keV
Phi unit: deg
PsiChi unit: None
CPU times: user 15.9 s, sys: 528 ms, total: 16.4 s
Wall time: 16.6 s
</pre></div></div>
</div>
<p><strong>Background</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

bkg_filepath = path_data + &quot;albedo_photons_3months_unbinned_data.fits.gz&quot;

binned_bkg = BinnedData(input_yaml = &quot;inputs_Crab_DC2.yaml&quot;)

binned_bkg.get_binned_data(unbinned_data = bkg_filepath, psichi_binning=&quot;galactic&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
binning data...
Time unit: s
Em unit: keV
Phi unit: deg
PsiChi unit: None
CPU times: user 1min 49s, sys: 3.88 s, total: 1min 53s
Wall time: 1min 54s
</pre></div></div>
</div>
<p>Convert the data into sparse matrices &amp; add the signal to the background</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>signal = binned_signal.binned_data.to_dense()
bkg = binned_bkg.binned_data.to_dense()
event = signal + bkg
</pre></div>
</div>
</div>
<p>Save the binned histograms</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>signal.write(&quot;crab_dc2_galactic_signal.hdf5&quot;, overwrite = True)
bkg.write(&quot;crab_dc2_galactic_bkg.hdf5&quot;, overwrite = True)
event.write(&quot;crab_dc2_galactic_event.hdf5&quot;, overwrite = True)
</pre></div>
</div>
</div>
<p>Load the saved files</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>signal = Histogram.open(&quot;crab_dc2_galactic_signal.hdf5&quot;)
bkg = Histogram.open(&quot;crab_dc2_galactic_bkg.hdf5&quot;)
event = Histogram.open(&quot;crab_dc2_galactic_event.hdf5&quot;)
</pre></div>
</div>
</div>
<p>In DC2, the number of time bins should be 1 when you perform the image deconvolution using the galactic CDS. It is because the pre-computed response files in the galactic coordinate have no time axis, and all of the events are assumed to be projected into a single galactic CDS. In the future, we plan to introduce more flexible binning.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>bkg.axes[&#39;Time&#39;].edges
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="math notranslate nohighlight">
$[1.8354873 \times 10^{9},~1.8434673 \times 10^{9}] \; \mathrm{s}$</div></div>
</div>
</section>
<section id="2.-Load-the-response-matrix">
<h1>2. Load the response matrix<a class="headerlink" href="#2.-Load-the-response-matrix" title="Link to this heading"></a></h1>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

response_path = path_data + &quot;psr_gal_continuum_DC2.h5&quot;

image_response = Histogram.open(response_path)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 2.24 s, sys: 17.7 s, total: 19.9 s
Wall time: 29.7 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_response.axes.labels
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([&#39;NuLambda&#39;, &#39;Ei&#39;, &#39;Em&#39;, &#39;Phi&#39;, &#39;PsiChi&#39;], dtype=&#39;&lt;U8&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_response.contents.shape
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(768, 10, 10, 36, 768)
</pre></div></div>
</div>
</section>
<section id="3.-Prepare-a-'fake'-coordsys-conversion-matrix">
<h1>3. Prepare a ‘fake’ coordsys conversion matrix<a class="headerlink" href="#3.-Prepare-a-'fake'-coordsys-conversion-matrix" title="Link to this heading"></a></h1>
<p>The coordsys conversion matrix was initially introduced to convert a model map in the Galactic coordinates into the local coordinates. In the case of this notebook, the CDS is in the Galactic coordinates; thus, ideally, we do not have to convert the coordinates of the model map. However, as for now, the code for the image deconvolution was mainly developed for the CDS in the local coordinates and requires the conversion matrix, so here, we generate a ‘fake’ coordinate conversion matrix, which is
an unit matrix. Then, the same code can be applied for both methods. We will consider removing this fake coordinate conversion matrix in the future.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>nside = image_response.axes[&#39;NuLambda&#39;].nside
nside
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
8
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>axes = [event.axes[&#39;Time&#39;],
        HealpixAxis(nside = nside, coordsys = &quot;galactic&quot;, label = &quot;lb&quot;),
        HealpixAxis(nside = nside, coordsys = &quot;galactic&quot;, label = &quot;NuLambda&quot;)]

ccm = CoordsysConversionMatrix(axes, binning_method = &#39;Time&#39;, unit = u.dimensionless_unscaled, sparse = True)

for ipix in range(axes[1].npix):
    ccm[:,ipix,ipix] = 1 * u.dimensionless_unscaled
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>ccm.contents
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<table><tbody><tr><th style="text-align: left">Format</th><td style="text-align: left">coo</td></tr><tr><th style="text-align: left">Data Type</th><td style="text-align: left">float64</td></tr><tr><th style="text-align: left">Shape</th><td style="text-align: left">(1, 768, 768)</td></tr><tr><th style="text-align: left">nnz</th><td style="text-align: left">768</td></tr><tr><th style="text-align: left">Density</th><td style="text-align: left">0.0013020833333333333</td></tr><tr><th style="text-align: left">Read-only</th><td style="text-align: left">True</td></tr><tr><th style="text-align: left">Size</th><td style="text-align: left">24.0K</td></tr><tr><th style="text-align: left">Storage ratio</th><td style="text-align: left">0.0</td></tr></tbody></table></div>
</div>
</section>
<section id="4.-Imaging-deconvolution">
<h1>4. Imaging deconvolution<a class="headerlink" href="#4.-Imaging-deconvolution" title="Link to this heading"></a></h1>
<section id="Brief-overview-of-the-image-deconvolution">
<h2>Brief overview of the image deconvolution<a class="headerlink" href="#Brief-overview-of-the-image-deconvolution" title="Link to this heading"></a></h2>
<p>Basically, we have to maximize the following likelihood function</p>
<div class="math notranslate nohighlight">
\[\log L = \sum_i X_i \log \epsilon_i - \sum_i \epsilon_i\]</div>
<p><span class="math notranslate nohighlight">\(X_i\)</span>: detected counts at <span class="math notranslate nohighlight">\(i\)</span>-th bin ( <span class="math notranslate nohighlight">\(i\)</span> : index of the Compton Data Space)</p>
<p><span class="math notranslate nohighlight">\(\epsilon_i = \sum_j R_{ij} \lambda_j + b_i\)</span> : expected counts ( <span class="math notranslate nohighlight">\(j\)</span> : index of the model space)</p>
<p><span class="math notranslate nohighlight">\(\lambda_j\)</span> : the model map (basically gamma-ray flux at <span class="math notranslate nohighlight">\(j\)</span>-th pixel)</p>
<p><span class="math notranslate nohighlight">\(b_i\)</span> : the background at <span class="math notranslate nohighlight">\(i\)</span>-th bin</p>
<p><span class="math notranslate nohighlight">\(R_{ij}\)</span> : the response matrix</p>
<p>Since we have to optimize the flux in each pixel, and the number of parameters is large, we adopt an iterative approach to find a solution of the above equation. The simplest one is the ML-EM (Maximum Likelihood Expectation Maximization) algorithm. It is also known as the Richardson-Lucy algorithm.</p>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \delta \lambda_{j}^{k}\]</div>
<div class="math notranslate nohighlight">
\[\delta \lambda_{j}^{k} = \frac{\lambda_{j}^{k}}{\sum_{i} R_{ij}} \sum_{i} \left(\frac{ X_{i} }{\epsilon_{i}} - 1 \right) R_{ij}\]</div>
<p>We refer to <span class="math notranslate nohighlight">\(\delta \lambda_{j}^{k}\)</span> as the delta map.</p>
<p>As for now, the two improved algorithms are implemented in COSIpy.</p>
<ul class="simple">
<li><p>Accelerated ML-EM algorithm (Knoedlseder+99)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \alpha^{k} \delta \lambda_{j}^{k}\]</div>
<div class="math notranslate nohighlight">
\[\alpha^{k} &lt; \mathrm{max}(- \lambda_{j}^{k} / \delta \lambda_{j}^{k})\]</div>
<p>Practically, in order not to accelerate the algorithm excessively, we set the maximum value of <span class="math notranslate nohighlight">\(\alpha\)</span> (<span class="math notranslate nohighlight">\(\alpha_{\mathrm{max}}\)</span>). Then, <span class="math notranslate nohighlight">\(\alpha\)</span> is calculated as:</p>
<div class="math notranslate nohighlight">
\[\alpha^{k} = \mathrm{min}(\mathrm{max}(- \lambda_{j}^{k} / \delta \lambda_{j}^{k}), \alpha_{\mathrm{max}})\]</div>
<ul class="simple">
<li><p>Noise damping using gaussian smoothing (Knoedlseder+05, Siegert+20)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \alpha^{k} \left[ w_j \delta \lambda_{j}^{k} \right]_{\mathrm{gauss}}\]</div>
<div class="math notranslate nohighlight">
\[w_j = \left(\sum_{i} R_{ij}\right)^\beta\]</div>
<p><span class="math notranslate nohighlight">\(\left[ ... \right]_{\mathrm{gauss}}\)</span> means that the differential image is smoothed by a gaussian filter.</p>
</section>
<section id="4-1.-Prepare-DataLoader-containing-all-neccesary-datasets">
<h2>4-1. Prepare DataLoader containing all neccesary datasets<a class="headerlink" href="#4-1.-Prepare-DataLoader-containing-all-neccesary-datasets" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataloader = DataLoader()

dataloader.event_dense = event
dataloader.bkg_dense = bkg

# the loaded response matrix should be assigned to both full_detector_response/image_response_dense in the Galactic CDS method.
dataloader.full_detector_response = image_response
dataloader.image_response_dense = image_response

dataloader.response_on_memory = True
dataloader.coordsys_conv_matrix = ccm
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataloader._modify_axes()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
... checking the axis Time of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
... checking the axis Em of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
... checking the axis Phi of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
... checking the axis PsiChi of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
...checking the axis Em of the event and response files...
    --&gt; pass (edges)
...checking the axis Phi of the event and response files...
    --&gt; pass (edges)
...checking the axis PsiChi of the event and response files...
    --&gt; pass (edges)
The axes in the event and background files are redefined. Now they are consistent with those of the response file.
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING FutureWarning: Note that _modify_axes() in DataLoader was implemented for a temporary use. It will be removed in the future.


WARNING UserWarning: Make sure to perform _modify_axes() only once after the data are loaded.

</pre></div></div>
</div>
<p>(In the future, we plan to remove the method “_modify_axes.”)</p>
<p>Here, we calculate an auxiliary matrix for the deconvolution. Basically, it is a response matrix projected into the model space (<span class="math notranslate nohighlight">\(\sum_{i} R_{ij}\)</span>). Currently, it is mandatory to run this command for the image deconvolution.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

dataloader.calc_image_response_projected()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
... (DataLoader) calculating a projected image response ...
CPU times: user 1.38 s, sys: 1.65 s, total: 3.03 s
Wall time: 3.09 s
</pre></div></div>
</div>
</section>
<section id="4-3.-Initialize-the-instance-of-the-image-deconvolution-class">
<h2>4-3. Initialize the instance of the image deconvolution class<a class="headerlink" href="#4-3.-Initialize-the-instance-of-the-image-deconvolution-class" title="Link to this heading"></a></h2>
<p>First, we prepare an instance of the ImageDeconvolution class and then register the dataset and parameters for the deconvolution. After that, you can start the calculation.</p>
<p>please modify this parameter_filepath corresponding to your environment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>parameter_filepath = &quot;imagedeconvolution_parfile_gal_Crab.yml&quot;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution = ImageDeconvolution()

# set dataloader to image_deconvolution
image_deconvolution.set_data(dataloader)

# set a parameter file for the image deconvolution
image_deconvolution.read_parameterfile(parameter_filepath)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
data for image deconvolution was set -&gt;  &lt;cosipy.image_deconvolution.data_loader.DataLoader object at 0x2da0f7eb0&gt;
parameter file for image deconvolution was set -&gt;  imagedeconvolution_parfile_gal_Crab.yml
</pre></div></div>
</div>
<section id="Initialize-image_deconvolution">
<h3>Initialize image_deconvolution<a class="headerlink" href="#Initialize-image_deconvolution" title="Link to this heading"></a></h3>
<p>In this process, a model map is defined following the input parameters, and it is initialized. Also, it prepares ancillary data for the image deconvolution, e.g., the expected counts with the initial model map, gaussian smoothing filter etc.</p>
<p>I describe parameters in the parameter file.</p>
<section id="model_property">
<h4>model_property<a class="headerlink" href="#model_property" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>coordinate</p></td>
<td><p>str</p></td>
<td><p>the coordinate system of the model map</p></td>
<td><p>As for now, it must be ‘galactic’</p></td>
</tr>
<tr class="row-odd"><td><p>nside</p></td>
<td><p>int</p></td>
<td><p>NSIDE of the model map</p></td>
<td><p>it must be the same as NSIDE of ‘lb’ axis of the coordinate conversion matrix</p></td>
</tr>
<tr class="row-even"><td><p>scheme</p></td>
<td><p>str</p></td>
<td><p>SCHEME of the model map</p></td>
<td><p>As for now, it must be ‘ring’</p></td>
</tr>
<tr class="row-odd"><td><p>energy_edges</p></td>
<td><p>list of float [keV]</p></td>
<td><p>The definition of the energy bins of the model map</p></td>
<td><p>As for now, it must be the same as that of the response matrix</p></td>
</tr>
</tbody>
</table>
</section>
<section id="model_initialization">
<h4>model_initialization<a class="headerlink" href="#model_initialization" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>algorithm</p></td>
<td><p>str</p></td>
<td><p>the method name to initialize the model map</p></td>
<td><p>As for now, only ‘flat’ can be used</p></td>
</tr>
<tr class="row-odd"><td><p>parameter_flat:values</p></td>
<td><p>list of float [cm-2 s-1 sr-1]</p></td>
<td><p>the list of photon fluxes for each energy band</p></td>
<td><p>the length of the list should be the same as the length of “energy_edges” - 1</p></td>
</tr>
</tbody>
</table>
</section>
<section id="deconvolution">
<h4>deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>algorithm</p></td>
<td><p>str</p></td>
<td><p>the name of the image deconvolution algorithm</p></td>
<td><p>As for now, only ‘RL’ is supported</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:iteration</p></td>
<td><p>int</p></td>
<td><p>The maximum number of the iteration</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:acceleration</p></td>
<td><p>bool</p></td>
<td><p>whether the accelerated ML-EM algorithm (Knoedlseder+99) is used</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:alpha_max</p></td>
<td><p>float</p></td>
<td><p>the maximum value for the acceleration parameter</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:save_results_each_iteration</p></td>
<td><p>bool</p></td>
<td><p>whether an updated model map, detal map, likelihood etc. are saved at the end of each iteration</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:response_weighting</p></td>
<td><p>bool</p></td>
<td><p>whether a delta map is renormalized based on the exposure time on each pixel, namely
<span class="math notranslate nohighlight">\(w_j = (\sum_{i} R_{ij})^{\beta}\)</span> (see Knoedlseder+05, Siegert+20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:response_weighting_index</p></td>
<td><p>float</p></td>
<td><p><span class="math notranslate nohighlight">\(\beta\)</span> in the above equation</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:smoothing</p></td>
<td><p>bool</p></td>
<td><p>whether a Gaussian filter is used (see Knoedlseder+05, Siegert+20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:smoothing_FWHM</p></td>
<td><p>float, degree</p></td>
<td><p>the FWHM of the Gaussian in the filter</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:background_normalization_fitting</p></td>
<td><p>bool</p></td>
<td><p>whether the background normalization factor is optimized at each iteration</p></td>
<td><p>As for now, the single background normalization factor is used in all of the bins</p></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:background_normalization_range</p></td>
<td><p>list of float</p></td>
<td><p>the range of the normalization factor</p></td>
<td><p>should be positive</p></td>
</tr>
</tbody>
</table>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.initialize()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Initialization ####
1. generating a model map
---- parameters ----
coordinate: galactic
energy_edges:
- 100.0
- 158.489
- 251.189
- 398.107
- 630.957
- 1000.0
- 1584.89
- 2511.89
- 3981.07
- 6309.57
- 10000.0
nside: 8
scheme: ring

2. initializing the model map ...
---- parameters ----
algorithm: flat
parameter_flat:
  values:
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4

3. registering the deconvolution algorithm ...
... calculating the expected events with the initial model map ...
... calculating the response weighting filter...
... calculating the gaussian filter...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "47c41cb7e171425fbd02a1fe23f0ea9d", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
---- parameters ----
algorithm: RL
parameter_RL:
  acceleration: true
  alpha_max: 10.0
  background_normalization_fitting: false
  background_normalization_range:
  - 0.01
  - 10.0
  iteration: 10
  response_weighting: true
  response_weighting_index: 0.5
  save_results_each_iteration: false
  smoothing: true
  smoothing_FWHM: 2.0
  smoothing_max_sigma: 10.0

#### Done ####

</pre></div></div>
</div>
</section>
</section>
<section id="(You-can-change-the-parameters-as-follows)">
<h3>(You can change the parameters as follows)<a class="headerlink" href="#(You-can-change-the-parameters-as-follows)" title="Link to this heading"></a></h3>
<p>Note that when you modify the parameters, do not forget to run “initialize” again!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:iteration = 50&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:background_normalization_fitting = True&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:alpha_max = 5.0&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:smoothing_FWHM = 3.0&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:response_weighting = False&quot;)

image_deconvolution.initialize()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Initialization ####
1. generating a model map
---- parameters ----
coordinate: galactic
energy_edges:
- 100.0
- 158.489
- 251.189
- 398.107
- 630.957
- 1000.0
- 1584.89
- 2511.89
- 3981.07
- 6309.57
- 10000.0
nside: 8
scheme: ring

2. initializing the model map ...
---- parameters ----
algorithm: flat
parameter_flat:
  values:
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4
  - 1e-4

3. registering the deconvolution algorithm ...
... calculating the expected events with the initial model map ...
... calculating the gaussian filter...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "24e7d35b578f4ec8af780927ae0cefbf", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
---- parameters ----
algorithm: RL
parameter_RL:
  acceleration: true
  alpha_max: 5.0
  background_normalization_fitting: true
  background_normalization_range:
  - 0.01
  - 10.0
  iteration: 50
  response_weighting: false
  response_weighting_index: 0.5
  save_results_each_iteration: false
  smoothing: true
  smoothing_FWHM: 3.0
  smoothing_max_sigma: 10.0

#### Done ####

</pre></div></div>
</div>
</section>
</section>
<section id="4-5.-Start-the-image-deconvolution">
<h2>4-5. Start the image deconvolution<a class="headerlink" href="#4-5.-Start-the-image-deconvolution" title="Link to this heading"></a></h2>
<p><strong>With MacBook Pro with M1 Max and 64 GB memory, it takes about 4 minutes for 50 iterations.</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

all_results = image_deconvolution.run_deconvolution()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Deconvolution Starts ####
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "35a3fe0840a246ed858f8dfe30521ab4", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Iteration 1/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 260079415.0311088
    background_normalization: 1.077578659034381
  Iteration 2/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 260401557.7357421
    background_normalization: 1.0747057018207677
  Iteration 3/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 260682519.76500124
    background_normalization: 1.0571054446248327
  Iteration 4/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 260809172.77131456
    background_normalization: 1.0309768887336166
  Iteration 5/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 260886454.33277905
    background_normalization: 1.021384848051889
  Iteration 6/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 260948848.85980994
    background_normalization: 1.0108113971582602
  Iteration 7/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 260990804.146106
    background_normalization: 1.010467249618972
  Iteration 8/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261020956.71722955
    background_normalization: 1.0006157261333617
  Iteration 9/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261042859.29807213
    background_normalization: 1.0058641809947886
  Iteration 10/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261043269.8568107
    background_normalization: 0.993741326854415
  Iteration 11/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261060491.10965943
    background_normalization: 1.0058657276309866
  Iteration 12/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261007827.2710289
    background_normalization: 0.9877974265453751
  Iteration 13/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261076265.054812
    background_normalization: 1.009811538136611
  Iteration 14/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261099396.40515625
    background_normalization: 1.0048700520907765
  Iteration 15/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261065843.9794334
    background_normalization: 0.9909347457044095
  Iteration 16/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261110094.00162172
    background_normalization: 1.0063495429365543
  Iteration 17/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261122168.5957638
    background_normalization: 1.002376744947073
  Iteration 18/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261096313.19243956
    background_normalization: 0.9913786458527394
  Iteration 19/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261129961.28983143
    background_normalization: 1.0040459860775908
  Iteration 20/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261137407.31313634
    background_normalization: 1.0006492242650211
  Iteration 21/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261116234.46936882
    background_normalization: 0.9913697621614236
  Iteration 22/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261143530.8942464
    background_normalization: 1.0023744856891161
  Iteration 23/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261148417.64207026
    background_normalization: 0.9993636106475906
  Iteration 24/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261130513.34431684
    background_normalization: 0.9912144784871131
  Iteration 25/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261134896.0466035
    background_normalization: 1.0010662808202762
  Iteration 26/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261066166.29685706
    background_normalization: 0.9857849794974954
  Iteration 27/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261132943.80258343
    background_normalization: 1.0068265206936726
  Iteration 28/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261148296.52335072
    background_normalization: 1.002108052281045
  Iteration 29/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261099965.81865662
    background_normalization: 0.9892543515924257
  Iteration 30/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261148351.3486695
    background_normalization: 1.0052136331020776
  Iteration 31/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261157018.92679334
    background_normalization: 1.0011610943268634
  Iteration 32/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261118727.1099544
    background_normalization: 0.9902093594726253
  Iteration 33/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261157889.93501914
    background_normalization: 1.0039161394431217
  Iteration 34/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261163498.17249128
    background_normalization: 1.0003082708761435
  Iteration 35/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261131700.08152235
    background_normalization: 0.9906204498077124
  Iteration 36/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261164799.9998866
    background_normalization: 1.0028450774020168
  Iteration 37/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261168573.0233805
    background_normalization: 0.9995616625471752
  Iteration 38/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261141391.23569417
    background_normalization: 0.9907927868095415
  Iteration 39/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261170119.05511898
    background_normalization: 1.0019485964391688
  Iteration 40/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261172684.28548497
    background_normalization: 0.9989160733417498
  Iteration 41/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261149001.1256929
    background_normalization: 0.9908537644843672
  Iteration 42/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261174372.75896752
    background_normalization: 1.0011848359144828
  Iteration 43/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261176099.88843274
    background_normalization: 0.9983550801218972
  Iteration 44/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261155194.31362218
    background_normalization: 0.9908594816570173
  Iteration 45/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261177870.56885752
    background_normalization: 1.00052012791432
  Iteration 46/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261178995.64073008
    background_normalization: 0.9978600300598851
  Iteration 47/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261160372.66833794
    background_normalization: 0.9908343850485126
  Iteration 48/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: 261180809.8795411
    background_normalization: 0.9999277350857754
  Iteration 49/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261181491.66160578
    background_normalization: 0.9974136084439371
  Iteration 50/50
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; stop
--&gt; registering results
--&gt; showing results
    alpha: 5.0
    loglikelihood: 261164793.80599907
    background_normalization: 0.9907885000950185
#### Done ####

CPU times: user 6min 3s, sys: 3min 40s, total: 9min 43s
Wall time: 4min 9s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pprint

pprint.pprint(all_results)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.077578659034381,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446202200&gt;,
  &#39;iteration&#39;: 1,
  &#39;loglikelihood&#39;: 260079415.0311088,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446201a50&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca2f0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0747057018207677,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca140&gt;,
  &#39;iteration&#39;: 2,
  &#39;loglikelihood&#39;: 260401557.7357421,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461caa70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cac50&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0571054446248327,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c93f0&gt;,
  &#39;iteration&#39;: 3,
  &#39;loglikelihood&#39;: 260682519.76500124,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9570&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9150&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0309768887336166,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c98a0&gt;,
  &#39;iteration&#39;: 4,
  &#39;loglikelihood&#39;: 260809172.77131456,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c8a30&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca830&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.021384848051889,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c89a0&gt;,
  &#39;iteration&#39;: 5,
  &#39;loglikelihood&#39;: 260886454.33277905,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c8640&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c8520&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0108113971582602,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb8b0&gt;,
  &#39;iteration&#39;: 6,
  &#39;loglikelihood&#39;: 260948848.85980994,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb880&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c8310&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.010467249618972,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c97b0&gt;,
  &#39;iteration&#39;: 7,
  &#39;loglikelihood&#39;: 260990804.146106,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b80d0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9d20&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0006157261333617,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb940&gt;,
  &#39;iteration&#39;: 8,
  &#39;loglikelihood&#39;: 261020956.71722955,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b85b0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c84f0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0058641809947886,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9930&gt;,
  &#39;iteration&#39;: 9,
  &#39;loglikelihood&#39;: 261042859.29807213,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b8940&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca050&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.993741326854415,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9db0&gt;,
  &#39;iteration&#39;: 10,
  &#39;loglikelihood&#39;: 261043269.8568107,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b8f70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c8c10&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0058657276309866,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca290&gt;,
  &#39;iteration&#39;: 11,
  &#39;loglikelihood&#39;: 261060491.10965943,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9900&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9c90&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9877974265453751,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb910&gt;,
  &#39;iteration&#39;: 12,
  &#39;loglikelihood&#39;: 261007827.2710289,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9d80&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c8790&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.009811538136611,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca980&gt;,
  &#39;iteration&#39;: 13,
  &#39;loglikelihood&#39;: 261076265.054812,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9f90&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb070&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0048700520907765,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ca0b0&gt;,
  &#39;iteration&#39;: 14,
  &#39;loglikelihood&#39;: 261099396.40515625,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba920&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c9090&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9909347457044095,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb760&gt;,
  &#39;iteration&#39;: 15,
  &#39;loglikelihood&#39;: 261065843.9794334,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bada0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c88b0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0063495429365543,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c93c0&gt;,
  &#39;iteration&#39;: 16,
  &#39;loglikelihood&#39;: 261110094.00162172,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb220&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461cb700&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.002376744947073,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb640&gt;,
  &#39;iteration&#39;: 17,
  &#39;loglikelihood&#39;: 261122168.5957638,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb5e0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb670&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9913786458527394,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b93c0&gt;,
  &#39;iteration&#39;: 18,
  &#39;loglikelihood&#39;: 261096313.19243956,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9fc0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb940&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0040459860775908,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba1d0&gt;,
  &#39;iteration&#39;: 19,
  &#39;loglikelihood&#39;: 261129961.28983143,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba080&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bbb20&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0006492242650211,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba380&gt;,
  &#39;iteration&#39;: 20,
  &#39;loglikelihood&#39;: 261137407.31313634,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba320&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b96c0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9913697621614236,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b92a0&gt;,
  &#39;iteration&#39;: 21,
  &#39;loglikelihood&#39;: 261116234.46936882,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255420&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bbdc0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0023744856891161,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b84f0&gt;,
  &#39;iteration&#39;: 22,
  &#39;loglikelihood&#39;: 261143530.8942464,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254f70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba410&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9993636106475906,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9210&gt;,
  &#39;iteration&#39;: 23,
  &#39;loglikelihood&#39;: 261148417.64207026,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255b70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba050&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9912144784871131,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9a80&gt;,
  &#39;iteration&#39;: 24,
  &#39;loglikelihood&#39;: 261130513.34431684,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255330&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba3b0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0010662808202762,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b97e0&gt;,
  &#39;iteration&#39;: 25,
  &#39;loglikelihood&#39;: 261134896.0466035,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446256c20&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bbbb0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9857849794974954,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba260&gt;,
  &#39;iteration&#39;: 26,
  &#39;loglikelihood&#39;: 261066166.29685706,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446256f80&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb8e0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0068265206936726,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b8070&gt;,
  &#39;iteration&#39;: 27,
  &#39;loglikelihood&#39;: 261132943.80258343,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446256ce0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bb460&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.002108052281045,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b8fd0&gt;,
  &#39;iteration&#39;: 28,
  &#39;loglikelihood&#39;: 261148296.52335072,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446256140&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461bbd90&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9892543515924257,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b8730&gt;,
  &#39;iteration&#39;: 29,
  &#39;loglikelihood&#39;: 261099965.81865662,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254040&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba560&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0052136331020776,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461b9480&gt;,
  &#39;iteration&#39;: 30,
  &#39;loglikelihood&#39;: 261148351.3486695,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462545e0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba5c0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0011610943268634,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257fa0&gt;,
  &#39;iteration&#39;: 31,
  &#39;loglikelihood&#39;: 261157018.92679334,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257f70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462560b0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9902093594726253,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257670&gt;,
  &#39;iteration&#39;: 32,
  &#39;loglikelihood&#39;: 261118727.1099544,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462576d0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462579a0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0039161394431217,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254910&gt;,
  &#39;iteration&#39;: 33,
  &#39;loglikelihood&#39;: 261157889.93501914,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254a60&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257790&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 1.0003082708761435,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446256770&gt;,
  &#39;iteration&#39;: 34,
  &#39;loglikelihood&#39;: 261163498.17249128,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462567d0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254880&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9906204498077124,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446256ad0&gt;,
  &#39;iteration&#39;: 35,
  &#39;loglikelihood&#39;: 261131700.08152235,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462fa5c0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255c90&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0028450774020168,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462fb370&gt;,
  &#39;iteration&#39;: 36,
  &#39;loglikelihood&#39;: 261164799.9998866,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dceb0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462fae60&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9995616625471752,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255000&gt;,
  &#39;iteration&#39;: 37,
  &#39;loglikelihood&#39;: 261168573.0233805,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461df160&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257d00&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9907927868095415,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255b40&gt;,
  &#39;iteration&#39;: 38,
  &#39;loglikelihood&#39;: 261141391.23569417,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dcc70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257250&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0019485964391688,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257460&gt;,
  &#39;iteration&#39;: 39,
  &#39;loglikelihood&#39;: 261170119.05511898,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461deb00&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462563e0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9989160733417498,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462fa530&gt;,
  &#39;iteration&#39;: 40,
  &#39;loglikelihood&#39;: 261172684.28548497,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461df130&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462f9240&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9908537644843672,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257760&gt;,
  &#39;iteration&#39;: 41,
  &#39;loglikelihood&#39;: 261149001.1256929,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dff40&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255ba0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0011848359144828,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462549d0&gt;,
  &#39;iteration&#39;: 42,
  &#39;loglikelihood&#39;: 261174372.75896752,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dfb80&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257940&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9983550801218972,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254eb0&gt;,
  &#39;iteration&#39;: 43,
  &#39;loglikelihood&#39;: 261176099.88843274,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461de3e0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446255780&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9908594816570173,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ba9b0&gt;,
  &#39;iteration&#39;: 44,
  &#39;loglikelihood&#39;: 261155194.31362218,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461ddfc0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2afc22bc0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.00052012791432,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446254970&gt;,
  &#39;iteration&#39;: 45,
  &#39;loglikelihood&#39;: 261177870.56885752,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dd360&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x446257c70&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9978600300598851,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462548e0&gt;,
  &#39;iteration&#39;: 46,
  &#39;loglikelihood&#39;: 261178995.64073008,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dd7e0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4462557e0&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9908343850485126,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc9a0&gt;,
  &#39;iteration&#39;: 47,
  &#39;loglikelihood&#39;: 261160372.66833794,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc8e0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc970&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9999277350857754,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461de1a0&gt;,
  &#39;iteration&#39;: 48,
  &#39;loglikelihood&#39;: 261180809.8795411,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc790&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dde40&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9974136084439371,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc490&gt;,
  &#39;iteration&#39;: 49,
  &#39;loglikelihood&#39;: 261181491.66160578,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc640&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dc610&gt;},
 {&#39;alpha&#39;: 5.0,
  &#39;background_normalization&#39;: 0.9907885000950185,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dda50&gt;,
  &#39;iteration&#39;: 50,
  &#39;loglikelihood&#39;: 261164793.80599907,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461c0190&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x4461dd390&gt;}]
</pre></div></div>
</div>
<p><strong>(If you want, you can save the results in the directory “./results” as follows)</strong></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os

os.mkdir(&quot;./results&quot;)

for result in all_results:
    iteration = result[&#39;iteration&#39;]
    result[&#39;model_map&#39;].write(f&#39;./results/model_map_itr{iteration}.hdf5&#39;)

    with open(f&#39;./results/result_itr{iteration}.txt&#39;, &#39;w&#39;) as f:
        paramlist = [&#39;alpha&#39;, &#39;loglikelihood&#39;, &#39;background_normalization&#39;]

        for param in paramlist:
            value = result[param]
            f.write(f&#39;{param}: {value}\n&#39;)
</pre></div>
</div>
</div>
</section>
</section>
<section id="5.-Analyze-the-results">
<h1>5. Analyze the results<a class="headerlink" href="#5.-Analyze-the-results" title="Link to this heading"></a></h1>
<p>Examples to see/analyze the results are shown below.</p>
<section id="Log-likelihood">
<h2>Log-likelihood<a class="headerlink" href="#Log-likelihood" title="Link to this heading"></a></h2>
<p>Plotting the log-likelihood vs the number of iterations</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in all_results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;loglikelihood&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;loglikelihood&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_52_0.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_52_0.png" />
</div>
</div>
</section>
<section id="Alpha-(the-factor-used-for-the-acceleration)">
<h2>Alpha (the factor used for the acceleration)<a class="headerlink" href="#Alpha-(the-factor-used-for-the-acceleration)" title="Link to this heading"></a></h2>
<p>Plotting <span class="math notranslate nohighlight">\(\alpha\)</span> vs the number of iterations. <span class="math notranslate nohighlight">\(\alpha\)</span> is a parameter to accelerate the EM algorithm (see the beginning of Section 4). If it is too large, reconstructed images may have artifacts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in all_results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;alpha&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;alpha&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_54_0.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_54_0.png" />
</div>
</div>
</section>
<section id="Background-normalization">
<h2>Background normalization<a class="headerlink" href="#Background-normalization" title="Link to this heading"></a></h2>
<p>Plotting the background nomalization factor vs the number of iterations. If the backgroud model is accurate and the image is reconstructed perfectly, this factor should be close to 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in all_results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;background_normalization&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;background_normalization&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_56_0.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_56_0.png" />
</div>
</div>
</section>
<section id="The-reconstructed-images">
<h2>The reconstructed images<a class="headerlink" href="#The-reconstructed-images" title="Link to this heading"></a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_reconstructed_image(result, source_position = None): # source_position should be (l,b) in degrees
    iteration = result[&#39;iteration&#39;]
    image = result[&#39;model_map&#39;]

    for energy_index in range(image.axes[&#39;Ei&#39;].nbins):
        map_healpxmap = HealpixMap(data = image[:,energy_index], unit = image.unit)

        _, ax = map_healpxmap.plot(&#39;mollview&#39;)

        _.colorbar.set_label(str(image.unit))

        if source_position is not None:
            ax.scatter(source_position[0]*u.deg, source_position[1]*u.deg, transform=ax.get_transform(&#39;world&#39;), color = &#39;red&#39;)

        plt.title(label = f&quot;iteration = {iteration}, energy_index = {energy_index} ({image.axes[&#39;Ei&#39;].bounds[energy_index][0]}-{image.axes[&#39;Ei&#39;].bounds[energy_index][1]})&quot;)
</pre></div>
</div>
</div>
<p>Plotting the reconstructed images in all of the energy bands at the 50th iteration</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration = 49

plot_reconstructed_image(all_results[iteration])
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_0.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_0.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_1.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_1.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_2.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_2.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_3.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_3.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_4.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_4.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_5.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_5.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_6.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_6.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_7.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_7.png" />
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_8.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_8.png" />
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_9.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_60_9.png" />
</div>
</div>
</section>
<section id="Integrated-flux-over-the-sky">
<h2>Integrated flux over the sky<a class="headerlink" href="#Integrated-flux-over-the-sky" title="Link to this heading"></a></h2>
<p>Define the Crab spectral model</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration = []
integrated_flux = []
integrated_flux_each_band = [[],[],[],[],[]]

for _ in all_results:
    iteration.append(_[&#39;iteration&#39;])
    image = _[&#39;model_map&#39;]
    pixelarea = 4 * np.pi / image.axes[&#39;lb&#39;].npix * u.sr

    integrated_flux.append(np.sum(image) * pixelarea)

    for energy_band in range(5):
        integrated_flux_each_band[energy_band].append(np.sum(image[:,energy_band]) * pixelarea)

plt.plot(iteration, [_.value for _ in integrated_flux], label = &#39;total&#39;, color = &#39;black&#39;)
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;integrated flux (ph cm-2 s-1)&quot;)
plt.yscale(&quot;log&quot;)

colors = [&#39;b&#39;, &#39;g&#39;, &#39;r&#39;, &#39;c&#39;, &#39;m&#39;]
for energy_band in range(5):
    plt.plot(iteration, [_.value for _ in integrated_flux_each_band[energy_band]], color = colors[energy_band], label = &quot;energyband = {}&quot;.format(energy_band))

plt.legend()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x446361ed0&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_62_1.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_62_1.png" />
</div>
</div>
</section>
<section id="Spectrum">
<h2>Spectrum<a class="headerlink" href="#Spectrum" title="Link to this heading"></a></h2>
<p>Plotting the gamma-ray spectrum at the 50th iteration. The photon flux at each energy band shown here is calculated as the accumulation of the flux values in all pixels at each energy band.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>energy_truth = []
flux_truth = []

with open(&quot;crab_spec.dat&quot;, &quot;r&quot;) as f:
    for line in f:
        data = line.split(&#39;\t&#39;)
        if data[0] == &#39;DP&#39;:
            energy_truth.append(float(data[1]))# * u.keV)
            flux_truth.append(float(data[2]))# / u.cm**2 / u.s / u.keV)
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def get_differential_flux(model_map):
    pixelarea = 4 * np.pi / model_map.axes[&#39;lb&#39;].npix * u.sr

    differential_flux = np.sum(model_map, axis = 0) * pixelarea / model_map.axes[&#39;Ei&#39;].widths

    return differential_flux
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration = 49

result = all_results[iteration]

model_map = result[&#39;model_map&#39;]

differential_flux = get_differential_flux(model_map)

energy_band = model_map.axes[&#39;Ei&#39;].centers

err_energy = model_map.axes[&#39;Ei&#39;].bounds.T - model_map.axes[&#39;Ei&#39;].centers
err_energy[0,:] *= -1

plt.errorbar(energy_band, differential_flux, xerr=err_energy, fmt=&#39;o&#39;, label = &#39;reconstructed&#39;)
plt.plot(energy_truth, flux_truth, label = &#39;truth&#39;)
plt.xscale(&quot;log&quot;)
plt.yscale(&quot;log&quot;)

plt.xlabel(&quot;Energy (keV)&quot;)
plt.ylabel(r&quot;Photon Flux (s$^{-1}$ cm$^{-2}$ keV$^{-1}$)&quot;)
plt.title(f&quot;Spectrum, Iteration = {result[&#39;iteration&#39;]}&quot;)
plt.grid()
plt.legend()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x3137d7d30&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_66_1.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_66_1.png" />
</div>
</div>
</section>
<section id="Plot-All">
<h2>Plot All<a class="headerlink" href="#Plot-All" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>title = [&quot;100-158.489 keV&quot;,
&quot;158.489-251.189 keV&quot;,
&quot;251.189-398.107 keV&quot;,
&quot;398.107-630.957 keV&quot;,
&quot;630.957-1000 keV&quot;,
&quot;1000-1584.89 keV&quot;,
&quot;1584.89-2511.89 keV&quot;,
&quot;2511.89-3981.07 keV&quot;,
&quot;3981.07-6309.57 keV&quot;,
&quot;6309.57-10000 keV&quot;]

position = {&quot;l&quot;:184.600, &quot;b&quot;: -5.800}

i_iteration = 49 # ==&gt;50th iteration
th = -5

fig = plt.figure(figsize=(30, 15))
gs = GridSpec(nrows=3, ncols=4)

ax0 = fig.add_subplot(gs[0, 0])
ax1 = fig.add_subplot(gs[0, 1])
ax2 = fig.add_subplot(gs[0, 2])
ax3 = fig.add_subplot(gs[0, 3])
ax4 = fig.add_subplot(gs[1, 0])
ax5 = fig.add_subplot(gs[1, 1])
ax6 = fig.add_subplot(gs[1, 2])
ax7 = fig.add_subplot(gs[1, 3])
ax8 = fig.add_subplot(gs[2, 0])
ax9 = fig.add_subplot(gs[2, 1])

axes = [ax0, ax1, ax2, ax3, ax4, ax5, ax6, ax7, ax8, ax9]

ax_spectrum = fig.add_subplot(gs[2, 2])
ax_likelihood = fig.add_subplot(gs[2, 3])
#ax_background = fig.add_subplot(gs[1, 3])

#plt.subplots_adjust(wspace=0.4, hspace=0.5)

image = all_results[i_iteration][&#39;model_map&#39;]

for i_energy in range(image.axes[&#39;Ei&#39;].nbins):
    plt.axes(axes[i_energy])

    data = image.contents[:,i_energy]
    data[data &lt; 10**th * image.unit] = 10**th * image.unit

    hp.mollview(data, norm = &#39;liner&#39;, min = 10**th, title = title[i_energy], hold=True, unit = &quot;s-1 sr-1 cm-2&quot;)
    hp.graticule(color=&#39;gray&#39;, dpar = 10, alpha = 0.5)
    hp.projscatter(theta = position[&quot;l&quot;], phi = position[&quot;b&quot;], lonlat = True, color = &#39;red&#39;, linewidths = 1, marker = &quot;*&quot;)

###

plt.axes(ax_spectrum)

energy_band = image.axes[&#39;Ei&#39;].centers

err_energy = image.axes[&#39;Ei&#39;].bounds.T - image.axes[&#39;Ei&#39;].centers
err_energy[0,:] *= -1

differential_flux = get_differential_flux(image)

plt.plot(energy_truth, flux_truth, label = &#39;truth&#39;)

plt.errorbar(energy_band, differential_flux, xerr=err_energy, fmt=&#39;o&#39;, label = &#39;reconstructed&#39;)
plt.xscale(&quot;log&quot;)
plt.yscale(&quot;log&quot;)
plt.xlim(90, 10000)
plt.ylim(1e-8, 2e-3)

plt.xlabel(&quot;Energy (keV)&quot;)
plt.ylabel(r&quot;Photon Flux (s$^{-1}$ cm$^{-2}$ keV$^{-1}$)&quot;)
plt.title(f&quot;Spectrum, Iteration = {iteration+1}&quot;)
plt.grid()
plt.legend()

###

plt.axes(ax_likelihood)

iterations = [_[&#39;iteration&#39;] for _ in all_results]
loglikelihoods = [_[&#39;loglikelihood&#39;] for _ in all_results]

plt.plot(iterations, loglikelihoods, linewidth = 1.5)
plt.plot([iterations[i_iteration]], [loglikelihoods[i_iteration]], markersize = 10, marker = &quot;.&quot;)

plt.xlabel(&quot;Iteration&quot;, fontsize = 12)
plt.title(&quot;Log-likelihood&quot;)
plt.grid()

###
#    plt.axes(ax_background)

#    plt.plot(iterations, background_normalizations, linewidth = 1.5)
#    plt.plot([iterations[i]], [background_normalizations[i]], markersize = 10, marker = &quot;.&quot;)

#    plt.xlabel(&quot;Iteration&quot;, fontsize = 12)
    #plt.ylabel(&quot;Background Normalization&quot;, fontsize = 12)
#    plt.ylim(0.7, 1.4)
#    plt.title(&quot;Background Normalization&quot;)
#    plt.grid()

#    plt.savefig(f&quot;fig_{i:03}.png&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_68_0.png" src="../../../../_images/tutorials_image_deconvolution_Crab_GalacticCDS_Crab-DC2-Galactic-ImageDeconvolution_68_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, COSI Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>