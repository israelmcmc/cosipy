<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>DC2 Image Analysis, 511 keV, Image Deconvolution &mdash; cosipy __version__ = &#34;0.2.1&#34;
 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../../../../_static/nbsphinx-code-cells.css" />

  
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../../../../_static/jquery.js?v=5d32c60e"></script>
        <script src="../../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../../../../_static/documentation_options.js?v=0aed9c3d"></script>
        <script src="../../../../_static/doctools.js?v=9a2dae69"></script>
        <script src="../../../../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" />
    <link rel="next" title="Other examples" href="../../../other_examples.html" />
    <link rel="prev" title="Diffuse 511 Spectral Fit in Galactic Coordinates" href="../../../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            cosipy
              <img src="../../../../_static/cosipy_logo.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../../../install.html">Installation</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../../../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../../../DataIO/DataIO_example.html">Data format and handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../response/SpacecraftFile.html">Spacecraft file: attitude and position</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../response/DetectorResponse.html">Detector response and signal expectation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../ts_map/Parallel_TS_map_computation_DC2.html">TS Map: localizing a GRB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectral_fits/continuum_fit/grb/SpectralFit_GRB.html">Fitting the spectrum of a GRB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectral_fits/continuum_fit/crab/SpectralFit_Crab.html">Fitting the spectrum of the Crab</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html">Extended source model fitting</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Image deconvolution</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#0.-Files-needed-for-this-notebook">0. Files needed for this notebook</a></li>
<li class="toctree-l3"><a class="reference internal" href="#1.-Read-the-response-matrix">1. Read the response matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#2.-Read-binned-511keV-binned-files-(source-and-background)">2. Read binned 511keV binned files (source and background)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#3.-Load-the-coordsys-conversion-matrix">3. Load the coordsys conversion matrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#4.-Imaging-deconvolution">4. Imaging deconvolution</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Brief-overview-of-the-image-deconvolution">Brief overview of the image deconvolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4-1.-Prepare-DataLoader-containing-all-neccesary-datasets">4-1. Prepare DataLoader containing all neccesary datasets</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4-2.-Load-the-response-file">4-2. Load the response file</a></li>
<li class="toctree-l4"><a class="reference internal" href="#4-3.-Initialize-the-instance-of-the-image-deconvolution-class">4-3. Initialize the instance of the image deconvolution class</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Initialize-image_deconvolution">Initialize image_deconvolution</a></li>
<li class="toctree-l4"><a class="reference internal" href="#(You-can-change-the-parameters-as-follows)">(You can change the parameters as follows)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#4-5.-Start-the-image-deconvolution">4-5. Start the image deconvolution</a></li>
<li class="toctree-l3"><a class="reference internal" href="#5.-Analyze-the-results">5. Analyze the results</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Log-likelihood">Log-likelihood</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Alpha-(the-factor-used-for-the-acceleration)">Alpha (the factor used for the acceleration)</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Background-normalization">Background normalization</a></li>
<li class="toctree-l4"><a class="reference internal" href="#The-reconstructed-images">The reconstructed images</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../other_examples.html">Other examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../../api/index.html">API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">cosipy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">DC2 Image Analysis, 511 keV, Image Deconvolution</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../../../_sources/tutorials/image_deconvolution/511keV/ScAttBinning/511keV-DC2-ScAtt-ImageDeconvolution.ipynb.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="DC2-Image-Analysis,-511-keV,-Image-Deconvolution">
<h1>DC2 Image Analysis, 511 keV, Image Deconvolution<a class="headerlink" href="#DC2-Image-Analysis,-511-keV,-Image-Deconvolution" title="Link to this heading"></a></h1>
<p>updated on 2024-01-30 (the commit 26cfdeacb25335bd511a91c4f8a29bdeb36408f2)</p>
<p>This notebook focuses on the image deconvolution with the spacecraft attitude (scatt) binning method for DC2. Using the 511 keV thin disk 3-month simulation data created for DC2, an example of the image analysis will be presented. If you have not run through 511keV-DC2-ScAtt-DataReduction.ipynb, please see it first.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from histpy import Histogram, HealpixAxis, Axis, Axes
from mhealpy import HealpixMap
from astropy.coordinates import SkyCoord, cartesian_to_spherical, Galactic

from cosipy.response import FullDetectorResponse
from cosipy.spacecraftfile import SpacecraftFile
from cosipy.ts_map.TSMap import TSMap
from cosipy.data_io import UnBinnedData, BinnedData
from cosipy.image_deconvolution import SpacecraftAttitudeExposureTable, CoordsysConversionMatrix, DataLoader, ImageDeconvolution

# cosipy uses astropy units
import astropy.units as u
from astropy.units import Quantity
from astropy.coordinates import SkyCoord
from astropy.time import Time
from astropy.table import Table
from astropy.io import fits
from scoords import Attitude, SpacecraftFrame

#3ML is needed for spectral modeling
from threeML import *
from astromodels import Band

#Other standard libraries
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.gridspec import GridSpec

import healpy as hp
from tqdm.autonotebook import tqdm

%matplotlib inline
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING: version mismatch between CFITSIO header (v4) and linked library (v4.01).

</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Welcome to JupyROOT 6.24/06
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">19:41:37 </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The naima package is not available. Models that depend on it will not be         </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">functions.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py#48" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">48</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">available                                                                         </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The GSL library or the pygsl wrapper cannot be loaded. Models that depend on it  </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">functions.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/functions/functions_1D/functions.py#69" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">69</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">will not be available.                                                            </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">19:41:38 </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The ebltable package is not available. Models that depend on it will not be     </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/functions/functions_1D/absorption.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">absorption.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/functions/functions_1D/absorption.py#36" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">36</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">available                                                                        </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">                </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of K to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive transform   </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py#704" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">704</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of K to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive transform   </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py#704" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">704</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of K to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive transform   </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py#704" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">704</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of K to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive transform   </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py#704" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">704</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of F to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive transform   </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py#704" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">704</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> We have set the min_value of K to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1e-99</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> because there was a postive transform   </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">parameter.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/astromodels/core/parameter.py#704" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">704</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">19:41:38 </span><span style="color: #00ffaf; text-decoration-color: #00ffaf">INFO    </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Starting 3ML!                                                                     </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#35" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">35</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> WARNINGs here are </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold">NOT</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> errors                                                      </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#36" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">36</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> but are inform you about optional packages that can be installed                  </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#37" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">37</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> </span><span style="color: #800000; text-decoration-color: #800000; font-weight: bold"> to disable these messages, turn off start_warning in your config file</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">            </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#40" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">40</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Multinest minimizer not available                                           </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/minimizer/minimization.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">minimization.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/minimizer/minimization.py#1357" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1357</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> PyGMO is not available                                                      </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/minimizer/minimization.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">minimization.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/minimizer/minimization.py#1369" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">1369</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> The cthreeML package is not installed. You will not be able to use plugins which  </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#94" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">94</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">require the C/C++ interface (currently HAWC)                                       </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">              </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Could not import plugin HAWCLike.py. Do you have the relative instrument         </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#144" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">144</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">software installed and configured?                                                </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Could not import plugin FermiLATLike.py. Do you have the relative instrument     </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#144" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">144</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">software installed and configured?                                                </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> No fermitools installed                                              </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/utils/data_builders/fermi/lat_transient_builder.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">lat_transient_builder.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/utils/data_builders/fermi/lat_transient_builder.py#44" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">44</span></a>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Env. variable OMP_NUM_THREADS is not set. Please set it to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> for optimal         </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#387" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">387</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">performances in 3ML                                                               </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Env. variable MKL_NUM_THREADS is not set. Please set it to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> for optimal         </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#387" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">387</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">performances in 3ML                                                               </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<pre style="white-space:pre;overflow-x:auto;line-height:normal;font-family:Menlo,'DejaVu Sans Mono',consolas,'Courier New',monospace"><span style="color: #00ff00; text-decoration-color: #00ff00">         </span><span style="color: #af5fd7; text-decoration-color: #af5fd7">WARNING </span> <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> Env. variable NUMEXPR_NUM_THREADS is not set. Please set it to </span><span style="color: #c0c0c0; text-decoration-color: #c0c0c0; font-weight: bold">1</span><span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold"> for optimal     </span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">__init__.py</span></a><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">:</span><a href="file:///Users/yoneda/Work/Exp/COSI/cosipy-2/cosipy-2-venv/lib/python3.10/site-packages/threeML/__init__.py#387" target="_blank"><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">387</span></a>
<span style="color: #00ff00; text-decoration-color: #00ff00">         </span>         <span style="color: #c6c6c6; text-decoration-color: #c6c6c6; font-weight: bold">performances in 3ML                                                               </span><span style="color: #7f7f7f; text-decoration-color: #7f7f7f">               </span>
</pre></div>
</div>
<section id="0.-Files-needed-for-this-notebook">
<h2>0. Files needed for this notebook<a class="headerlink" href="#0.-Files-needed-for-this-notebook" title="Link to this heading"></a></h2>
<p>From wasabi - cosi-pipeline-public/COSI-SMEX/DC2/Responses/SMEXv12.511keV.HEALPixO4.binnedimaging.imagingresponse.nonsparse_nside16.area.h5</p>
<p>From docs/tutorials/image_deconvolution/511keV/ScAttBinning - inputs_511keV_DC2.yaml - imagedeconvolution_parfile_scatt_511keV.yml</p>
<p>As outputs from the notebook 511keV-DC2-ScAtt-DataReduction.ipynb - 511keV_scatt_binning_DC2_bkg.hdf5 - 511keV_scatt_binning_DC2_event.hdf5 - ccm.hdf5</p>
</section>
<section id="1.-Read-the-response-matrix">
<h2>1. Read the response matrix<a class="headerlink" href="#1.-Read-the-response-matrix" title="Link to this heading"></a></h2>
<p>please modify “path_data” corresponding to your environment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>path_data = &quot;path/to/data/&quot;
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>response_path = path_data + &quot;SMEXv12.511keV.HEALPixO4.binnedimaging.imagingresponse.nonsparse_nside16.area.h5&quot;

response = FullDetectorResponse.open(response_path)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>response
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
FILENAME: &#39;/Users/yoneda/Work/Exp/COSI/cosipy-2/data_challenge/DC2/prework/data/Responses/SMEXv12.511keV.HEALPixO4.binnedimaging.imagingresponse.nonsparse_nside16.area.h5&#39;
AXES:
  NuLambda:
    DESCRIPTION: &#39;Location of the simulated source in the spacecraft coordinates&#39;
    TYPE: &#39;healpix&#39;
    NPIX: 3072
    NSIDE: 16
    SCHEME: &#39;RING&#39;
  Ei:
    DESCRIPTION: &#39;Initial simulated energy&#39;
    TYPE: &#39;log&#39;
    UNIT: &#39;keV&#39;
    NBINS: 1
    EDGES: [509.0 keV, 513.0 keV]
  Em:
    DESCRIPTION: &#39;Measured energy&#39;
    TYPE: &#39;log&#39;
    UNIT: &#39;keV&#39;
    NBINS: 1
    EDGES: [509.0 keV, 513.0 keV]
  Phi:
    DESCRIPTION: &#39;Compton angle&#39;
    TYPE: &#39;linear&#39;
    UNIT: &#39;deg&#39;
    NBINS: 60
    EDGES: [0.0 deg, 3.0 deg, 6.0 deg, 9.0 deg, 12.0 deg, 15.0 deg, 18.0 deg, 21.0 deg, 24.0 deg, 27.0 deg, 30.0 deg, 33.0 deg, 36.0 deg, 39.0 deg, 42.0 deg, 45.0 deg, 48.0 deg, 51.0 deg, 54.0 deg, 57.0 deg, 60.0 deg, 63.0 deg, 66.0 deg, 69.0 deg, 72.0 deg, 75.0 deg, 78.0 deg, 81.0 deg, 84.0 deg, 87.0 deg, 90.0 deg, 93.0 deg, 96.0 deg, 99.0 deg, 102.0 deg, 105.0 deg, 108.0 deg, 111.0 deg, 114.0 deg, 117.0 deg, 120.0 deg, 123.0 deg, 126.0 deg, 129.0 deg, 132.0 deg, 135.0 deg, 138.0 deg, 141.0 deg, 144.0 deg, 147.0 deg, 150.0 deg, 153.0 deg, 156.0 deg, 159.0 deg, 162.0 deg, 165.0 deg, 168.0 deg, 171.0 deg, 174.0 deg, 177.0 deg, 180.0 deg]
  PsiChi:
    DESCRIPTION: &#39;Location in the Compton Data Space&#39;
    TYPE: &#39;healpix&#39;
    NPIX: 3072
    NSIDE: 16
    SCHEME: &#39;RING&#39;

</pre></div></div>
</div>
</section>
<section id="2.-Read-binned-511keV-binned-files-(source-and-background)">
<h2>2. Read binned 511keV binned files (source and background)<a class="headerlink" href="#2.-Read-binned-511keV-binned-files-(source-and-background)" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

#  background
data_bkg = BinnedData(&quot;inputs_511keV_DC2.yaml&quot;)
data_bkg.load_binned_data_from_hdf5(&quot;511keV_scatt_binning_DC2_bkg.hdf5&quot;)

##  signal + background
data_511keV = BinnedData(&quot;inputs_511keV_DC2.yaml&quot;)
data_511keV.load_binned_data_from_hdf5(&quot;511keV_scatt_binning_DC2_event.hdf5&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 149 ms, sys: 806 ms, total: 955 ms
Wall time: 958 ms
</pre></div></div>
</div>
</section>
<section id="3.-Load-the-coordsys-conversion-matrix">
<h2>3. Load the coordsys conversion matrix<a class="headerlink" href="#3.-Load-the-coordsys-conversion-matrix" title="Link to this heading"></a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

ccm = CoordsysConversionMatrix.open(&quot;ccm.hdf5&quot;)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.63 s, sys: 77.8 ms, total: 1.71 s
Wall time: 1.72 s
</pre></div></div>
</div>
</section>
<section id="4.-Imaging-deconvolution">
<h2>4. Imaging deconvolution<a class="headerlink" href="#4.-Imaging-deconvolution" title="Link to this heading"></a></h2>
<section id="Brief-overview-of-the-image-deconvolution">
<h3>Brief overview of the image deconvolution<a class="headerlink" href="#Brief-overview-of-the-image-deconvolution" title="Link to this heading"></a></h3>
<p>Basically, we have to maximize the following likelihood function</p>
<div class="math notranslate nohighlight">
\[\log L = \sum_i X_i \log \epsilon_i - \sum_i \epsilon_i\]</div>
<p><span class="math notranslate nohighlight">\(X_i\)</span>: detected counts at <span class="math notranslate nohighlight">\(i\)</span>-th bin ( <span class="math notranslate nohighlight">\(i\)</span> : index of the Compton Data Space)</p>
<p><span class="math notranslate nohighlight">\(\epsilon_i = \sum_j R_{ij} \lambda_j + b_i\)</span> : expected counts ( <span class="math notranslate nohighlight">\(j\)</span> : index of the model space)</p>
<p><span class="math notranslate nohighlight">\(\lambda_j\)</span> : the model map (basically gamma-ray flux at <span class="math notranslate nohighlight">\(j\)</span>-th pixel)</p>
<p><span class="math notranslate nohighlight">\(b_i\)</span> : the background at <span class="math notranslate nohighlight">\(i\)</span>-th bin</p>
<p><span class="math notranslate nohighlight">\(R_{ij}\)</span> : the response matrix</p>
<p>Since we have to optimize the flux in each pixel, and the number of parameters is large, we adopt an iterative approach to find a solution of the above equation. The simplest one is the ML-EM (Maximum Likelihood Expectation Maximization) algorithm. It is also known as the Richardson-Lucy algorithm.</p>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \delta \lambda_{j}^{k}\]</div>
<div class="math notranslate nohighlight">
\[\delta \lambda_{j}^{k} = \frac{\lambda_{j}^{k}}{\sum_{i} R_{ij}} \sum_{i} \left(\frac{ X_{i} }{\epsilon_{i}} - 1 \right) R_{ij}\]</div>
<p>We refer to <span class="math notranslate nohighlight">\(\delta \lambda_{j}^{k}\)</span> as the delta map.</p>
<p>As for now, the two improved algorithms are implemented in COSIpy.</p>
<ul class="simple">
<li><p>Accelerated ML-EM algorithm (Knoedlseder+99)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \alpha^{k} \delta \lambda_{j}^{k}\]</div>
<div class="math notranslate nohighlight">
\[\alpha^{k} &lt; \mathrm{max}(- \lambda_{j}^{k} / \delta \lambda_{j}^{k})\]</div>
<p>Practically, in order not to accelerate the algorithm excessively, we set the maximum value of <span class="math notranslate nohighlight">\(\alpha\)</span> (<span class="math notranslate nohighlight">\(\alpha_{\mathrm{max}}\)</span>). Then, <span class="math notranslate nohighlight">\(\alpha\)</span> is calculated as:</p>
<div class="math notranslate nohighlight">
\[\alpha^{k} = \mathrm{min}(\mathrm{max}(- \lambda_{j}^{k} / \delta \lambda_{j}^{k}), \alpha_{\mathrm{max}})\]</div>
<ul class="simple">
<li><p>Noise damping using gaussian smoothing (Knoedlseder+05, Siegert+20)</p></li>
</ul>
<div class="math notranslate nohighlight">
\[\lambda_{j}^{k+1} = \lambda_{j}^{k} + \alpha^{k} \left[ w_j \delta \lambda_{j}^{k} \right]_{\mathrm{gauss}}\]</div>
<div class="math notranslate nohighlight">
\[w_j = \left(\sum_{i} R_{ij}\right)^\beta\]</div>
<p><span class="math notranslate nohighlight">\(\left[ ... \right]_{\mathrm{gauss}}\)</span> means that the differential image is smoothed by a gaussian filter.</p>
</section>
<section id="4-1.-Prepare-DataLoader-containing-all-neccesary-datasets">
<h3>4-1. Prepare DataLoader containing all neccesary datasets<a class="headerlink" href="#4-1.-Prepare-DataLoader-containing-all-neccesary-datasets" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataloader = DataLoader.load(data_511keV.binned_data,
                             data_bkg.binned_data,
                             response,
                             ccm,
                             is_miniDC2_format = False)
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataloader._modify_axes()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING FutureWarning: Note that _modify_axes() in DataLoader was implemented for a temporary use. It will be removed in the future.


WARNING UserWarning: Make sure to perform _modify_axes() only once after the data are loaded.

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
... checking the axis ScAtt of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
... checking the axis Em of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
... checking the axis Phi of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
... checking the axis PsiChi of the event and background files...
    --&gt; pass (edges)
    --&gt; pass (unit)
...checking the axis Em of the event and response files...
    --&gt; pass (edges)
...checking the axis Phi of the event and response files...
    --&gt; pass (edges)
...checking the axis PsiChi of the event and response files...
    --&gt; pass (edges)
The axes in the event and background files are redefined. Now they are consistent with those of the response file.
</pre></div></div>
</div>
<p>(In the future, we plan to remove the method “_modify_axes.”)</p>
</section>
<section id="4-2.-Load-the-response-file">
<h3>4-2. Load the response file<a class="headerlink" href="#4-2.-Load-the-response-file" title="Link to this heading"></a></h3>
<p>The response file will be loaded on the CPU memory. It requires a few GB. In the actual COSI satellite analysis, the response could be much larger, perhaps ~1TB wiht finer bin size.</p>
<p>So loading it on the memory might be unrealistic in the future. The optimized (lazy) loading would be a next work.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

dataloader.load_full_detector_response_on_memory()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 13.5 s, sys: 1.48 s, total: 15 s
Wall time: 15 s
</pre></div></div>
</div>
<p>Here, we calculate an auxiliary matrix for the deconvolution. Basically, it is a response matrix projected into the model space (<span class="math notranslate nohighlight">\(\sum_{i} R_{ij}\)</span>). Currently, it is mandatory to run this command for the image deconvolution.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>dataloader.calc_image_response_projected()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
... (DataLoader) calculating a projected image response ...
</pre></div></div>
</div>
</section>
<section id="4-3.-Initialize-the-instance-of-the-image-deconvolution-class">
<h3>4-3. Initialize the instance of the image deconvolution class<a class="headerlink" href="#4-3.-Initialize-the-instance-of-the-image-deconvolution-class" title="Link to this heading"></a></h3>
<p>First, we prepare an instance of the ImageDeconvolution class and then register the dataset and parameters for the deconvolution. After that, you can start the calculation.</p>
<p>please modify this parameter_filepath corresponding to your environment.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>parameter_filepath = &quot;imagedeconvolution_parfile_scatt_511keV.yml&quot;
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution = ImageDeconvolution()

# set dataloader to image_deconvolution
image_deconvolution.set_data(dataloader)

# set a parameter file for the image deconvolution
image_deconvolution.read_parameterfile(parameter_filepath)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
data for image deconvolution was set -&gt;  &lt;cosipy.image_deconvolution.data_loader.DataLoader object at 0x2b65478e0&gt;
parameter file for image deconvolution was set -&gt;  imagedeconvolution_parfile_scatt_511keV.yml
</pre></div></div>
</div>
</section>
<section id="Initialize-image_deconvolution">
<h3>Initialize image_deconvolution<a class="headerlink" href="#Initialize-image_deconvolution" title="Link to this heading"></a></h3>
<p>In this process, a model map is defined following the input parameters, and it is initialized. Also, it prepares ancillary data for the image deconvolution, e.g., the expected counts with the initial model map, gaussian smoothing filter etc.</p>
<p>I describe parameters in the parameter file.</p>
<section id="model_property">
<h4>model_property<a class="headerlink" href="#model_property" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>coordinate</p></td>
<td><p>str</p></td>
<td><p>the coordinate system of the model map</p></td>
<td><p>As for now, it must be ‘galactic’</p></td>
</tr>
<tr class="row-odd"><td><p>nside</p></td>
<td><p>int</p></td>
<td><p>NSIDE of the model map</p></td>
<td><p>it must be the same as NSIDE of ‘lb’ axis of the coordinate conversion matrix</p></td>
</tr>
<tr class="row-even"><td><p>scheme</p></td>
<td><p>str</p></td>
<td><p>SCHEME of the model map</p></td>
<td><p>As for now, it must be ‘ring’</p></td>
</tr>
<tr class="row-odd"><td><p>energy_edges</p></td>
<td><p>list of float [keV]</p></td>
<td><p>The definition of the energy bins of the model map</p></td>
<td><p>As for now, it must be the same as that of the response matrix</p></td>
</tr>
</tbody>
</table>
</section>
<section id="model_initialization">
<h4>model_initialization<a class="headerlink" href="#model_initialization" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>algorithm</p></td>
<td><p>str</p></td>
<td><p>the method name to initialize the model map</p></td>
<td><p>As for now, only ‘flat’ can be used</p></td>
</tr>
<tr class="row-odd"><td><p>parameter_flat:values</p></td>
<td><p>list of float [cm-2 s-1 sr-1]</p></td>
<td><p>the list of photon fluxes for each energy band</p></td>
<td><p>the length of the list should be the same as the length of “energy_edges” - 1</p></td>
</tr>
</tbody>
</table>
</section>
<section id="deconvolution">
<h4>deconvolution<a class="headerlink" href="#deconvolution" title="Link to this heading"></a></h4>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Name</p></th>
<th class="head"><p>Unit</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Notes</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>algorithm</p></td>
<td><p>str</p></td>
<td><p>the name of the image deconvolution algorithm</p></td>
<td><p>As for now, only ‘RL’ is supported</p></td>
</tr>
<tr class="row-odd"><td></td>
<td></td>
<td></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:iteration</p></td>
<td><p>int</p></td>
<td><p>The maximum number of the iteration</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:acceleration</p></td>
<td><p>bool</p></td>
<td><p>whether the accelerated ML-EM algorithm (Knoedlseder+99) is used</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:alpha_max</p></td>
<td><p>float</p></td>
<td><p>the maximum value for the acceleration parameter</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:save_results_each_iteration</p></td>
<td><p>bool</p></td>
<td><p>whether an updated model map, detal map, likelihood etc. are saved at the end of each iteration</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:response_weighting</p></td>
<td><p>bool</p></td>
<td><p>whether a delta map is renormalized based on the exposure time on each pixel, namely
<span class="math notranslate nohighlight">\(w_j = (\sum_{i} R_{ij})^{\beta}\)</span> (see Knoedlseder+05, Siegert+20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:response_weighting_index</p></td>
<td><p>float</p></td>
<td><p><span class="math notranslate nohighlight">\(\beta\)</span> in the above equation</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:smoothing</p></td>
<td><p>bool</p></td>
<td><p>whether a Gaussian filter is used (see Knoedlseder+05, Siegert+20)</p></td>
<td></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:smoothing_FWHM</p></td>
<td><p>float, degree</p></td>
<td><p>the FWHM of the Gaussian in the filter</p></td>
<td></td>
</tr>
<tr class="row-even"><td><p>parameter_RL:background_normalization_fitting</p></td>
<td><p>bool</p></td>
<td><p>whether the background normalization factor is optimized at each iteration</p></td>
<td><p>As for now, the single background normalization factor is used in all of the bins</p></td>
</tr>
<tr class="row-odd"><td><p>parameter_RL:background_normalization_range</p></td>
<td><p>list of float</p></td>
<td><p>the range of the normalization factor</p></td>
<td><p>should be positive</p></td>
</tr>
</tbody>
</table>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.initialize()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Initialization ####
1. generating a model map
---- parameters ----
coordinate: galactic
energy_edges:
- 509.0
- 513.0
nside: 16
scheme: ring

2. initializing the model map ...
---- parameters ----
algorithm: flat
parameter_flat:
  values:
  - 1e-4

3. registering the deconvolution algorithm ...
... calculating the expected events with the initial model map ...
... calculating the response weighting filter...
... calculating the gaussian filter...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "787a76408f87451687d9cad617f808c7", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
---- parameters ----
algorithm: RL
parameter_RL:
  acceleration: true
  alpha_max: 10.0
  background_normalization_fitting: false
  background_normalization_range:
  - 0.01
  - 10.0
  iteration: 10
  response_weighting: true
  response_weighting_index: 0.5
  save_results_each_iteration: false
  smoothing: true
  smoothing_FWHM: 2.0
  smoothing_max_sigma: 10.0

#### Done ####

</pre></div></div>
</div>
</section>
</section>
<section id="(You-can-change-the-parameters-as-follows)">
<h3>(You can change the parameters as follows)<a class="headerlink" href="#(You-can-change-the-parameters-as-follows)" title="Link to this heading"></a></h3>
<p>Note that when you modify the parameters, do not forget to run “initialize” again!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:iteration = 30&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:background_normalization_fitting = True&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:alpha_max = 10&quot;)
image_deconvolution.override_parameter(&quot;deconvolution:parameter_RL:smoothing_FWHM = 3.0&quot;)

image_deconvolution.initialize()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Initialization ####
1. generating a model map
---- parameters ----
coordinate: galactic
energy_edges:
- 509.0
- 513.0
nside: 16
scheme: ring

2. initializing the model map ...
---- parameters ----
algorithm: flat
parameter_flat:
  values:
  - 1e-4

3. registering the deconvolution algorithm ...
... calculating the expected events with the initial model map ...
... calculating the response weighting filter...
... calculating the gaussian filter...
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "7588d06581354a01a7524559604db3ae", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
---- parameters ----
algorithm: RL
parameter_RL:
  acceleration: true
  alpha_max: 10
  background_normalization_fitting: true
  background_normalization_range:
  - 0.01
  - 10.0
  iteration: 30
  response_weighting: true
  response_weighting_index: 0.5
  save_results_each_iteration: false
  smoothing: true
  smoothing_FWHM: 3.0
  smoothing_max_sigma: 10.0

#### Done ####

</pre></div></div>
</div>
</section>
</section>
<section id="4-5.-Start-the-image-deconvolution">
<h2>4-5. Start the image deconvolution<a class="headerlink" href="#4-5.-Start-the-image-deconvolution" title="Link to this heading"></a></h2>
<p><strong>With MacBook Pro with M1 Max and 64 GB memory, it takes about 6 minutes for 30 iterations.</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>%%time

all_results = image_deconvolution.run_deconvolution()
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
#### Deconvolution Starts ####
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<script type="application/vnd.jupyter.widget-view+json">{"model_id": "3f9e0f566265430b83a796729b4f80d3", "version_major": 2, "version_minor": 0}</script></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
  Iteration 1/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>

WARNING RuntimeWarning: invalid value encountered in divide

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 2.5039460293538105
    loglikelihood: -1563364.0277526558
    background_normalization: 1.0048700233481955
  Iteration 2/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1519357.4702937151
    background_normalization: 0.9944142064277177
  Iteration 3/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 2.4670760938135765
    loglikelihood: -1499867.5506138196
    background_normalization: 0.999275691887223
  Iteration 4/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1496920.474980764
    background_normalization: 1.0004892236020582
  Iteration 5/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 4.546207203696152
    loglikelihood: -1490909.3204384344
    background_normalization: 0.9998689870447892
  Iteration 6/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1490365.0435509903
    background_normalization: 0.9995258381190871
  Iteration 7/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 2.854692362839457
    loglikelihood: -1489307.7214813665
    background_normalization: 0.9997388449308033
  Iteration 8/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1489058.487761884
    background_normalization: 0.9998124108372027
  Iteration 9/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 2.2283812062183777
    loglikelihood: -1488593.384611151
    background_normalization: 0.9997745302553334
  Iteration 10/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1488431.7662045578
    background_normalization: 0.999764145247152
  Iteration 11/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.2705691250781777
    loglikelihood: -1488249.8944230902
    background_normalization: 0.9997686118565604
  Iteration 12/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1488124.8362333952
    background_normalization: 0.9997696073518008
  Iteration 13/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1488012.3045336306
    background_normalization: 0.9997697876916849
  Iteration 14/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.2230022900243092
    loglikelihood: -1487888.5786615435
    background_normalization: 0.9997700189565418
  Iteration 15/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1487798.520730182
    background_normalization: 0.9997703163980328
  Iteration 16/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.8098974214440344
    loglikelihood: -1487652.4673017936
    background_normalization: 0.999770562358397
  Iteration 17/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1487583.1765680623
    background_normalization: 0.999771015377049
  Iteration 18/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 5.618448128695514
    loglikelihood: -1487253.9933618857
    background_normalization: 0.9997712604348642
  Iteration 19/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1487215.6271944637
    background_normalization: 0.9997727102976933
  Iteration 20/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 4.541756790045432
    loglikelihood: -1487060.3103523117
    background_normalization: 0.999772909371205
  Iteration 21/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1487034.1422262355
    background_normalization: 0.9997739086816684
  Iteration 22/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1487009.4576823683
    background_normalization: 0.9997741100024176
  Iteration 23/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1486986.1429297891
    background_normalization: 0.9997742950835806
  Iteration 24/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1486964.0949290707
    background_normalization: 0.9997744737637747
  Iteration 25/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 4.967042011343623
    loglikelihood: -1486864.6152302232
    background_normalization: 0.9997746469610125
  Iteration 26/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1486848.7990036565
    background_normalization: 0.9997754874062363
  Iteration 27/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.6330713142086324
    loglikelihood: -1486824.3117899313
    background_normalization: 0.9997756319817698
  Iteration 28/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1486810.3517182083
    background_normalization: 0.9997758601840663
  Iteration 29/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; continue
--&gt; registering results
--&gt; showing results
    alpha: 1.1820824055223498
    loglikelihood: -1486794.6074471278
    background_normalization: 0.9997759950994234
  Iteration 30/30
--&gt; pre-processing
--&gt; E-step
... skip E-step ...
--&gt; M-step
--&gt; post-processing
... calculating the expected events with the updated model map ...
--&gt; checking stopping criteria
--&gt; --&gt; stop
--&gt; registering results
--&gt; showing results
    alpha: 1.0
    loglikelihood: -1486781.9555685548
    background_normalization: 0.9997761488793757
#### Done ####

CPU times: user 33min 1s, sys: 3min 35s, total: 36min 37s
Wall time: 5min 41s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import pprint

pprint.pprint(all_results)
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[{&#39;alpha&#39;: &lt;Quantity 2.50394603&gt;,
  &#39;background_normalization&#39;: 1.0048700233481955,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8a2f0&gt;,
  &#39;iteration&#39;: 1,
  &#39;loglikelihood&#39;: -1563364.0277526558,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8a380&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b89f00&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9944142064277177,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x10368e1d0&gt;,
  &#39;iteration&#39;: 2,
  &#39;loglikelihood&#39;: -1519357.4702937151,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2b657bc70&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88850&gt;},
 {&#39;alpha&#39;: &lt;Quantity 2.46707609&gt;,
  &#39;background_normalization&#39;: 0.999275691887223,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8bd60&gt;,
  &#39;iteration&#39;: 3,
  &#39;loglikelihood&#39;: -1499867.5506138196,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ba00&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b89990&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 1.0004892236020582,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ad70&gt;,
  &#39;iteration&#39;: 4,
  &#39;loglikelihood&#39;: -1496920.474980764,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2b6568820&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88430&gt;},
 {&#39;alpha&#39;: &lt;Quantity 4.5462072&gt;,
  &#39;background_normalization&#39;: 0.9998689870447892,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8afb0&gt;,
  &#39;iteration&#39;: 5,
  &#39;loglikelihood&#39;: -1490909.3204384344,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8afe0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b89780&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9995258381190871,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8bf40&gt;,
  &#39;iteration&#39;: 6,
  &#39;loglikelihood&#39;: -1490365.0435509903,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8b970&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88880&gt;},
 {&#39;alpha&#39;: &lt;Quantity 2.85469236&gt;,
  &#39;background_normalization&#39;: 0.9997388449308033,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8a410&gt;,
  &#39;iteration&#39;: 7,
  &#39;loglikelihood&#39;: -1489307.7214813665,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ac50&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ae30&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9998124108372027,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07790&gt;,
  &#39;iteration&#39;: 8,
  &#39;loglikelihood&#39;: -1489058.487761884,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e076d0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07f10&gt;},
 {&#39;alpha&#39;: &lt;Quantity 2.22838121&gt;,
  &#39;background_normalization&#39;: 0.9997745302553334,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b89600&gt;,
  &#39;iteration&#39;: 9,
  &#39;loglikelihood&#39;: -1488593.384611151,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ae60&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88340&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.999764145247152,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b896f0&gt;,
  &#39;iteration&#39;: 10,
  &#39;loglikelihood&#39;: -1488431.7662045578,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ad10&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8b0d0&gt;},
 {&#39;alpha&#39;: &lt;Quantity 1.27056913&gt;,
  &#39;background_normalization&#39;: 0.9997686118565604,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07bb0&gt;,
  &#39;iteration&#39;: 11,
  &#39;loglikelihood&#39;: -1488249.8944230902,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e05a50&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07670&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997696073518008,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88640&gt;,
  &#39;iteration&#39;: 12,
  &#39;loglikelihood&#39;: -1488124.8362333952,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88cd0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b882b0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997697876916849,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8b0a0&gt;,
  &#39;iteration&#39;: 13,
  &#39;loglikelihood&#39;: -1488012.3045336306,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8a4a0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b89840&gt;},
 {&#39;alpha&#39;: &lt;Quantity 1.22300229&gt;,
  &#39;background_normalization&#39;: 0.9997700189565418,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8bc10&gt;,
  &#39;iteration&#39;: 14,
  &#39;loglikelihood&#39;: -1487888.5786615435,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8aad0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b89540&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997703163980328,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e075e0&gt;,
  &#39;iteration&#39;: 15,
  &#39;loglikelihood&#39;: -1487798.520730182,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e05ae0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x10367dbd0&gt;},
 {&#39;alpha&#39;: &lt;Quantity 1.80989742&gt;,
  &#39;background_normalization&#39;: 0.999770562358397,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b88d30&gt;,
  &#39;iteration&#39;: 16,
  &#39;loglikelihood&#39;: -1487652.4673017936,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8a2c0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07880&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.999771015377049,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07df0&gt;,
  &#39;iteration&#39;: 17,
  &#39;loglikelihood&#39;: -1487583.1765680623,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07b20&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2b6569b10&gt;},
 {&#39;alpha&#39;: &lt;Quantity 5.61844813&gt;,
  &#39;background_normalization&#39;: 0.9997712604348642,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b8ace0&gt;,
  &#39;iteration&#39;: 18,
  &#39;loglikelihood&#39;: -1487253.9933618857,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2b6579690&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b029b0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997727102976933,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07c40&gt;,
  &#39;iteration&#39;: 19,
  &#39;loglikelihood&#39;: -1487215.6271944637,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e06950&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b024d0&gt;},
 {&#39;alpha&#39;: &lt;Quantity 4.54175679&gt;,
  &#39;background_normalization&#39;: 0.999772909371205,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b018d0&gt;,
  &#39;iteration&#39;: 20,
  &#39;loglikelihood&#39;: -1487060.3103523117,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2b6569780&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b000d0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997739086816684,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07460&gt;,
  &#39;iteration&#39;: 21,
  &#39;loglikelihood&#39;: -1487034.1422262355,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x373e07700&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b016f0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997741100024176,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b02bc0&gt;,
  &#39;iteration&#39;: 22,
  &#39;loglikelihood&#39;: -1487009.4576823683,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b00c40&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b01a80&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997742950835806,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b005e0&gt;,
  &#39;iteration&#39;: 23,
  &#39;loglikelihood&#39;: -1486986.1429297891,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b013f0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b03ac0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997744737637747,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b00f40&gt;,
  &#39;iteration&#39;: 24,
  &#39;loglikelihood&#39;: -1486964.0949290707,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b01150&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b021d0&gt;},
 {&#39;alpha&#39;: &lt;Quantity 4.96704201&gt;,
  &#39;background_normalization&#39;: 0.9997746469610125,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b00100&gt;,
  &#39;iteration&#39;: 25,
  &#39;loglikelihood&#39;: -1486864.6152302232,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b002b0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b020b0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997754874062363,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b03730&gt;,
  &#39;iteration&#39;: 26,
  &#39;loglikelihood&#39;: -1486848.7990036565,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b03ca0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b02ce0&gt;},
 {&#39;alpha&#39;: &lt;Quantity 1.63307131&gt;,
  &#39;background_normalization&#39;: 0.9997756319817698,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b02fe0&gt;,
  &#39;iteration&#39;: 27,
  &#39;loglikelihood&#39;: -1486824.3117899313,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b02200&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b035b0&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997758601840663,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b03490&gt;,
  &#39;iteration&#39;: 28,
  &#39;loglikelihood&#39;: -1486810.3517182083,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b011b0&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b02ad0&gt;},
 {&#39;alpha&#39;: &lt;Quantity 1.18208241&gt;,
  &#39;background_normalization&#39;: 0.9997759950994234,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b03c10&gt;,
  &#39;iteration&#39;: 29,
  &#39;loglikelihood&#39;: -1486794.6074471278,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b01030&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b00c70&gt;},
 {&#39;alpha&#39;: 1.0,
  &#39;background_normalization&#39;: 0.9997761488793757,
  &#39;delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b02e90&gt;,
  &#39;iteration&#39;: 30,
  &#39;loglikelihood&#39;: -1486781.9555685548,
  &#39;model_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x374b01330&gt;,
  &#39;processed_delta_map&#39;: &lt;cosipy.image_deconvolution.modelmap.ModelMap object at 0x2b65790c0&gt;}]
</pre></div></div>
</div>
</section>
<section id="5.-Analyze-the-results">
<h2>5. Analyze the results<a class="headerlink" href="#5.-Analyze-the-results" title="Link to this heading"></a></h2>
<p>Examples to see/analyze the results are shown below.</p>
<section id="Log-likelihood">
<h3>Log-likelihood<a class="headerlink" href="#Log-likelihood" title="Link to this heading"></a></h3>
<p>Plotting the log-likelihood vs the number of iterations</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in all_results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;loglikelihood&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;loglikelihood&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_35_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_35_0.png" />
</div>
</div>
</section>
<section id="Alpha-(the-factor-used-for-the-acceleration)">
<h3>Alpha (the factor used for the acceleration)<a class="headerlink" href="#Alpha-(the-factor-used-for-the-acceleration)" title="Link to this heading"></a></h3>
<p>Plotting <span class="math notranslate nohighlight">\(\alpha\)</span> vs the number of iterations. <span class="math notranslate nohighlight">\(\alpha\)</span> is a parameter to accelerate the EM algorithm (see the beginning of Section 4). If it is too large, reconstructed images may have artifacts.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in all_results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;alpha&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;alpha&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_37_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_37_0.png" />
</div>
</div>
</section>
<section id="Background-normalization">
<h3>Background normalization<a class="headerlink" href="#Background-normalization" title="Link to this heading"></a></h3>
<p>Plotting the background nomalization factor vs the number of iterations. If the background model is accurate and the image is reconstructed perfectly, this factor should be close to 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>x, y = [], []

for result in all_results:
    x.append(result[&#39;iteration&#39;])
    y.append(result[&#39;background_normalization&#39;])

plt.plot(x, y)
plt.grid()
plt.xlabel(&quot;iteration&quot;)
plt.ylabel(&quot;background_normalization&quot;)
plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_39_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_39_0.png" />
</div>
</div>
</section>
<section id="The-reconstructed-images">
<h3>The reconstructed images<a class="headerlink" href="#The-reconstructed-images" title="Link to this heading"></a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def plot_reconstructed_image(result, source_position = None): # source_position should be (l,b) in degrees
    iteration = result[&#39;iteration&#39;]
    image = result[&#39;model_map&#39;]

    for energy_index in range(image.axes[&#39;Ei&#39;].nbins):
        map_healpxmap = HealpixMap(data = image[:,energy_index], unit = image.unit)

        _, ax = map_healpxmap.plot(&#39;mollview&#39;)

        _.colorbar.set_label(str(image.unit))

        if source_position is not None:
            ax.scatter(source_position[0]*u.deg, source_position[1]*u.deg, transform=ax.get_transform(&#39;world&#39;), color = &#39;red&#39;)

        plt.title(label = f&quot;iteration = {iteration}, energy_index = {energy_index} ({image.axes[&#39;Ei&#39;].bounds[energy_index][0]}-{image.axes[&#39;Ei&#39;].bounds[energy_index][1]})&quot;)
</pre></div>
</div>
</div>
<p>Plotting the reconstructed images in all of the energy bands at the 20th iteration</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration = 19

plot_reconstructed_image(all_results[iteration])
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_43_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_43_0.png" />
</div>
</div>
<p>An example to plot the image in the log scale</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>iteration_idx = 29

result = all_results[iteration_idx]

iteration = result[&#39;iteration&#39;]
image = result[&#39;model_map&#39;]

data = image[:,0]
data[data &lt;= 0 * data.unit] = 1e-12 * data.unit

hp.mollview(data, min = 1e-5, norm =&#39;log&#39;, unit = str(data.unit), title = f&#39;511 keV image at {iteration}th iteration&#39;, cmap = &#39;magma&#39;)

plt.show()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_45_0.png" src="../../../../_images/tutorials_image_deconvolution_511keV_ScAttBinning_511keV-DC2-ScAtt-ImageDeconvolution_45_0.png" />
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>
</pre></div>
</div>
</div>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../../../spectral_fits/extended_source_fit/diffuse_511_spectral_fit.html" class="btn btn-neutral float-left" title="Diffuse 511 Spectral Fit in Galactic Coordinates" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../../../other_examples.html" class="btn btn-neutral float-right" title="Other examples" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2022, COSI Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>